<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="design.css" rel="stylesheet">
    <script src='https://kit.fontawesome.com/a076d05399.js' crossorigin='anonymous'></script>

    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.14.0-beta3/dist/css/bootstrap-select.min.css">
    <script src="https://code.jquery.com/jquery-3.6.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
    <!--
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.min.js" integrity="sha384-VHvPCCyXqtD5DqJeNxl2dtTyhF78xXNXdkwX1CZeRusQfRKp+tA7hAShOK/B/fQ2" crossorigin="anonymous"></script>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    -->
    <!-- Latest compiled and minified JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.14.0-beta3/dist/js/bootstrap-select.min.js"></script>
<style>
    h1   {text-align:center;}
    #selectTable, th, tr, td{
      border: 1px solid black;
      border-collapse: collapse;
      padding: 10px;
      align-items: center;
      text-align: center;
    }

  #selectTable .selectedRow
  {
    background-color: #6ccbfb;
    color: #fff;
  } 
</style>
</head>
<body>
<%- include("nav") %>
<h1><u>Create New Review</u></h1>
<br><br>

<div class="container" style="width: 50%; border-style:dashed;border-radius: 5px; padding: 10px; margin-left: auto; margin-right: auto;">
<div>
  Projects:
  <br>
  <select id="projSelector" class="selectpicker" data-live-search="true">
    <% if (typeof(projs) != 'undefined') { %>
      <% for(var i=0; i < projs.length; i++) { %>
      <option data-tokens="<%= projs[i] %>"><%= projs[i] %></option>
        <% } %>
      <% } %>
  </select>
  <br>
  <br>
  <div class="form-group">
    <label for="RevTitle">Review Title:</label>
    <input name="reviewtitle" type="text" class="form-control" id="RevTitle" placeholder="Enter Review Title" required>
  </div>
  <br>
<div class="form-group">
  <label for="Code">Code:</label>
  <textarea name="code" class="form-control" id="Code" rows="5" required></textarea>
</div>
<div>
  <label for="Tags">Tags</label>
  <select class="selectpicker" id="selectTag" data-live-search="true">
    <% if (typeof(tags) != 'undefined') { %>
      <% for(var i=0; i < tags.length; i++) { %>
      <option data-tokens="<%= tags[i] %>"><%= tags[i].name %></option>
        <% } %>
      <% } %>
  </select>
</div>
<button class="btn btn-secondary" type="button" id="btn" name="add">add</button>
<p id="tagsList"></p>
    <br><br>
    <button class="btn" style="background-color: #99FF33;" type="button" id="upRevList" name="upRevList">Get Reviewers List</button>
    <br><br>
    <div class="form-group">
      <select class="selectpicker" id="selManReviewer" data-live-search="true">
      <% if (typeof(users) != 'undefined') { %>
        <% for(var i=0; i < users.length; i++) { %>
        <option data-tokens="<%= users[i].username %>"><%= users[i].username %></option>
          <% } %>
        <% } %>
      </select>
    </div>
    <div class="form-group">
    <label for="ChooseReviewers">Choose Reviewers:</label>
    <br>
    <div class="d-flex bd-highlight">
      <div class="d-flex justify-content-start">
              <!--
    <select id="selectp2" class="selectpicker" data-live-search="true" data-live-search-style="startsWith">

      <option data-tokens="Select1">Select1</option>
      <option data-tokens="Select2">Select2</option>
      <option data-tokens="Select3">Select3</option>
     
    </select>
     -->
     <table id="selectTable">
      <thead>
        <th>Username</th>
        <th>Function Result</th>
        <th>Reason</th>
      </thead>
      <tbody>

      </tbody>
     </table>
  </div>

    </div>  
    <p id="reviewersList"></p>
  </div>
  <br><br>
  <div class="form-group" style="text-align: center;">
      <button id="createReviewBtn" type="submit" class="btn btn-primary">Create</button>
  </div>
  </div>
</div>
<script>
  var addTagToSet = document.getElementById("btn");
  const tags = new Set();
  const reviewers = new Set();
  addTagToSet.addEventListener("click",InsertTag);

  function InsertTag(event) {
    selectElement = document.querySelector('#selectTag');
    output = selectElement.value;
    tags.add(output);
    console.log(tags);
    tagsList = document.getElementById("tagsList");
    tagsList.innerHTML = 'Tags: #';
    tagsList.innerHTML += [...tags].join(', #');
    
  }

  function toggleClass(el, className) {
    if (el.className.indexOf(className) >= 0) {
      el.className = el.className.replace(className,"");
      el.cells[2].getElementsByTagName("textarea")[0].disabled = true;
    }
    else {
      el.className  += className;
      el.cells[2].getElementsByTagName("textarea")[0].disabled = false;
      el.cells[2].getElementsByTagName("textarea")[0].setAttribute("onclick", "event.stopPropagation()");
    }
  }



  $( document ).ready(function() {
    $("#upRevList").click(function(){
    tagsList = document.getElementById("tagsList");
    $( "#selectTable tbody tr" ).fadeOut("normal", function() {
        $(this).remove();
    });
    project = $('#projSelector').val();
    console.log("tags: "+tags);
    $.post('/createnewreview/updateList',
          {'tags': [...tags],
            'project': project
          },
          function(data) {
            selectTable = $( "#selectTable tbody" )
            console.log(data);
            dataFromServer = JSON.parse(data);
            mapEntries = dataFromServer[0]["maxPotentialMap"].sort((a,b)=> b[1]-a[1]);
            idsDict = dataFromServer[0]["idsDict"];
            for (let entry of mapEntries)
            {
              //entry = entry.toString().replace(",", ", ");
              entry = entry.toString().split(",");
              selectTable.append(`<tr onclick="toggleClass(this,'selectedRow');"><td id="`+idsDict[entry[0]]+`">`+entry[0]+`</td><td>`+entry[1]+`</td><td><textarea disabled></textarea></td></tr></option>`);
            }

          }
    );
  });

  $("#createReviewBtn").click(function(){
    project = $('#projSelector').val();
    title = $('#RevTitle').val();
    code = $('#Code').val();
    chosenRows_ids = [];
    chosenRows_reasons = [];
    $('.selectedRow').find("td:first").each(function(){chosenRows_ids.push($(this).prop("id"))});
    $('.selectedRow').find("td:nth-child(3) textarea").each(function(){chosenRows_reasons.push($(this).val())});
    $.post('/createnewreview/',
      {'project': project,
       'title': title,
       'code': code,
       'tags': [...tags],
       'chosenRows': chosenRows_ids,
       'reason': chosenRows_reasons
      },
      function(data) {
        window.location.href = "/existingreview/"+data;
      }
    );
  
  });
 
});
  
</script>
</body>
</html>